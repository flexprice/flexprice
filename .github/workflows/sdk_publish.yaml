name: Publish Go SDK
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'SDK Version (e.g., 1.0.0)'
        required: true
      dry_run:
        description: 'Dry run mode (true/false)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Speakeasy
        run: |
          curl -fsSL https://raw.githubusercontent.com/speakeasy-api/speakeasy/main/install.sh | sh
          echo "$HOME/.speakeasy/bin" >> $GITHUB_PATH
      
      - name: Authenticate Speakeasy
        run: |
          speakeasy auth login --api-key ${{ secrets.SPEAKEASY_API_KEY }}
        env:
          SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
      
      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'
      
      - name: Generate SDK with Speakeasy
        run: |
          speakeasy run --target flexprice-go-sdk || (echo "SDK generation encountered warnings but continuing..." && test -d api/go)
        env:
          SPEAKEASY_API_KEY: ${{ secrets.SPEAKEASY_API_KEY }}
      
      - name: Verify SDK was generated
        run: |
          ls -la api/go
          cd api/go && go mod tidy && go build ./...
      
      - name: Publish Go SDK to GitHub
        if: ${{ !inputs.dry_run }}
        run: |
          # Configure Git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Clone the Go SDK repository
          git clone https://x-access-token:${{ secrets.SDK_DEPLOY_GIT_TOKEN }}@github.com/flexprice/go-sdk.git ~/go-sdk-repo
          
          # Copy SDK files to the cloned repo
          rm -rf ~/go-sdk-repo/* || true
          rm -rf ~/go-sdk-repo/.* 2>/dev/null || true
          cp -r api/go/* ~/go-sdk-repo/ || echo "No files to copy from api/go"

          # Copy the license file
          cp LICENSE ~/go-sdk-repo/ || echo "LICENSE not found but continuing"
          
          # Push to GitHub
          cd ~/go-sdk-repo
          git add .
          git commit -m "Update SDK to version ${{ inputs.version }}" || echo "Nothing to commit"
          git tag -a "v${{ inputs.version }}" -m "Version ${{ inputs.version }}" || echo "Tag already exists"
          git push origin main
          git push --tags
            
          echo "Go SDK published successfully to GitHub with version ${{ inputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.SDK_DEPLOY_GIT_TOKEN }}
      
      - name: Dry Run Info
        if: ${{ inputs.dry_run }}
        run: |
          echo "=== DRY RUN MODE ==="
          echo "SDK was generated successfully but NOT published."
          echo "Would publish version: ${{ inputs.version }}"
          echo "Repository: github.com/flexprice/go-sdk"
          echo "Generated files:"
          ls -la api/go

