# ğŸ¯ Benthos Config - Real Customer Test
# Customer: Test Develop
# External ID: 334230687423
# Subscription: subs_01KB01K36X4H6MEVCW0SR0PX0N
# Plan: test (plan_01K99R3J7PDT3EJT5YJ3ZJXWP8)
# 
# Meter Details:
#   - Event Name: "feature 1"
#   - Aggregation: SUM
#   - Aggregation Field: "feature 1"
#   - Usage Limit: 2000 (resets monthly)
#   - Price: $0.01 per unit
#
# This will send 100 events consuming 100-1000 units total

input:
  generate:
    interval: 200ms  # Generate one event every 200ms (faster)
    count: 100       # Send 100 events
    # ğŸ”¹ BLOBLANG MAPPING - Benthos' data transformation language
    # This converts empty messages into Flexprice event format
    mapping: |
      # Set the event name - MUST match your meter's event_name exactly
      root.event_name = "feature 1"
      
      # Use your real customer's external_id from the customer object
      root.external_customer_id = "334230687423"
      
      # Properties - the key "feature 1" MUST match your meter's aggregation field
      # This is what gets summed up for billing
      root.properties = {
        "feature 1": random_int(min: 1, max: 10),
        "user_agent": "benthos/test",
        "region": "us-east-1",
        "request_id": uuid_v4()
      }
      
      # Source identifier (helps you track where events came from)
      root.source = "benthos-integration-test"
      
      # Timestamp in ISO 8601 format
      root.timestamp = now().format_timestamp("2006-01-02T15:04:05Z07:00")

pipeline:
  processors:
    # ğŸ”¹ BLOBLANG used here too - for logging and transformations
    - log:
        level: INFO
        message: |
          ğŸ“¤ Sending event #${!count("events")}:
          - Customer: Test Develop (334230687423)
          - Event: ${!json("event_name")}
          - Usage Amount: ${!json("properties").get("feature 1")} units
          - Total Billed: $${!json("properties").get("feature 1") * 0.01}
          - Request ID: ${!json("properties.request_id")}
    
    # Optional: Add a batch counter to track progress
    - mapping: |
        root = this
        root.batch_number = count("batch_counter")

output:
  http_client:
    url: "${FLEXPRICE_BASE_URL:http://localhost:8080}/v1/events"
    verb: POST
    headers:
      Content-Type: application/json
      x-api-key: "${FLEXPRICE_API_KEY}"
    timeout: 10s
    retry_period: 1s
    retries: 3
    successful_on:
      - 202
    backoff_on:
      - 429
    drop_on:
      - 400
      - 401
      - 403

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ğŸ“š BLOBLANG EXPLANATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Bloblang is Benthos' data transformation language (like jq or JSONPath)
# 
# WHERE IS BLOBLANG USED IN THIS CONFIG?
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. input.generate.mapping (lines 19-35)
#    - Transforms empty messages into Flexprice events
#    - Creates the JSON structure Flexprice expects
# 
# 2. pipeline.processors[0].log.message (lines 40-46)
#    - Uses ${!json("field")} syntax to extract values for logging
#    - The ${!...} notation evaluates Bloblang expressions
# 
# 3. pipeline.processors[1].mapping (lines 50-52)
#    - Adds a batch counter to track progress
#    - `root = this` copies the entire message
#    - `count("name")` increments a counter
# 
# COMMON BLOBLANG FUNCTIONS:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# - random_int(min: 1, max: 10)  â†’ Random number between 1-10
# - uuid_v4()                     â†’ Generate UUID
# - now()                         â†’ Current timestamp
# - format_timestamp("layout")    â†’ Format time as string
# - json("path")                  â†’ Extract JSON field
# - count("counter_name")         â†’ Increment counter
# - this                          â†’ Current message
# - root                          â†’ Output message
# 
# LEARN MORE: https://www.benthos.dev/docs/guides/bloblang/about
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
